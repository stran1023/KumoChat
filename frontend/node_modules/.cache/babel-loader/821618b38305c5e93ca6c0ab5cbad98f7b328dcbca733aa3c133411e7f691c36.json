{"ast":null,"code":"var _jsxFileName = \"D:\\\\Chuyen nganh\\\\\\u0110\\u1ED3 \\xE1n ATTT\\\\KumoChat\\\\frontend\\\\src\\\\components\\\\chat\\\\PrivateChat.jsx\",\n  _s = $RefreshSig$();\nimport { useState, useEffect, useContext } from \"react\";\nimport { Box, Typography, List, ListItem, ListItemButton, ListItemText, Divider } from \"@mui/material\";\nimport axios from \"axios\";\nimport { AuthContext } from \"../../context/AuthContext\";\nimport MessageArea from \"./MessageArea\";\nimport { SocketContext } from \"../../context/SocketContext\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nexport default function PrivateChat() {\n  _s();\n  const {\n    token,\n    user\n  } = useContext(AuthContext);\n  const [users, setUsers] = useState([]);\n  const [selectedUser, setSelectedUser] = useState(null);\n  const [departmentId, setDepartmentId] = useState(null);\n  const {\n    socket\n  } = useContext(SocketContext);\n  const [onlineUserIds, setOnlineUserIds] = useState([]);\n  useEffect(() => {\n    if (!socket) return;\n    socket.on(\"update_online_users\", ids => setOnlineUserIds(ids));\n    return () => socket.off(\"update_online_users\");\n  }, [socket]);\n\n  // Lấy phòng ban của mình trước\n  useEffect(() => {\n    const fetchDepartment = async () => {\n      try {\n        var _res$data$department, _res$data$departments, _res$data$departments2;\n        const res = await axios.get(`${process.env.REACT_APP_API_URL}/auth/me`, {\n          headers: {\n            Authorization: `Bearer ${token}`\n          }\n        });\n        const depId = ((_res$data$department = res.data.department) === null || _res$data$department === void 0 ? void 0 : _res$data$department.id) || ((_res$data$departments = res.data.departments) === null || _res$data$departments === void 0 ? void 0 : (_res$data$departments2 = _res$data$departments[0]) === null || _res$data$departments2 === void 0 ? void 0 : _res$data$departments2.id);\n        setDepartmentId(depId);\n      } catch (err) {\n        console.error(\"❌ Lỗi lấy phòng ban:\", err);\n      }\n    };\n    fetchDepartment();\n  }, [token]);\n\n  // Sau đó fetch user cùng phòng ban\n  useEffect(() => {\n    const fetchUsers = async () => {\n      if (!departmentId) return;\n      try {\n        const res = await axios.get(`${process.env.REACT_APP_API_URL}/departments/${departmentId}/users`, {\n          headers: {\n            Authorization: `Bearer ${token}`\n          }\n        });\n        const filtered = res.data.filter(u => u.id !== user.userId);\n        setUsers(filtered);\n      } catch (err) {\n        console.error(\"❌ Lỗi lấy user trong phòng ban:\", err);\n      }\n    };\n    fetchUsers();\n  }, [departmentId, token, user.userId]);\n  const [messages, setMessages] = useState([]);\n\n  // Load tin nhắn cũ\n  useEffect(() => {\n    const fetchHistory = async () => {\n      if (!selectedUser) return;\n      try {\n        const res = await axios.get(`${process.env.REACT_APP_API_URL}/messages/private/${selectedUser.id}`, {\n          headers: {\n            Authorization: `Bearer ${token}`\n          }\n        });\n        setMessages(res.data); // 👈 lưu tin nhắn cũ\n      } catch (err) {\n        console.error(\"❌ Không lấy được tin nhắn cũ:\", err);\n      }\n    };\n    fetchHistory();\n  }, [selectedUser, token]);\n  return /*#__PURE__*/_jsxDEV(Box, {\n    children: [/*#__PURE__*/_jsxDEV(Typography, {\n      variant: \"subtitle1\",\n      children: \"\\uD83E\\uDDCD Ch\\u1ECDn ng\\u01B0\\u1EDDi trong ph\\xF2ng ban \\u0111\\u1EC3 nh\\u1EAFn tin\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 79,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(List, {\n      dense: true,\n      sx: {\n        maxHeight: 200,\n        overflow: \"auto\",\n        bgcolor: \"#f4f4f4\",\n        mt: 1\n      },\n      children: users.map(u => /*#__PURE__*/_jsxDEV(ListItem, {\n        disablePadding: true,\n        children: /*#__PURE__*/_jsxDEV(ListItemButton, {\n          onClick: () => setSelectedUser(u),\n          children: /*#__PURE__*/_jsxDEV(ListItemText, {\n            primary: u.username,\n            secondary: onlineUserIds.includes(u.id) ? \"🟢 Online\" : \"⚪️ Offline\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 85,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 84,\n          columnNumber: 13\n        }, this)\n      }, u.id, false, {\n        fileName: _jsxFileName,\n        lineNumber: 83,\n        columnNumber: 11\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 81,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Divider, {\n      sx: {\n        my: 2\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 94,\n      columnNumber: 7\n    }, this), selectedUser ? /*#__PURE__*/_jsxDEV(MessageArea, {\n      mode: \"private\",\n      target: selectedUser,\n      userList: users,\n      initialMessages: messages\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 97,\n      columnNumber: 9\n    }, this) : /*#__PURE__*/_jsxDEV(Typography, {\n      variant: \"body2\",\n      color: \"text.secondary\",\n      children: \"Ch\\u1ECDn m\\u1ED9t ng\\u01B0\\u1EDDi \\u0111\\u1EC3 b\\u1EAFt \\u0111\\u1EA7u tr\\xF2 chuy\\u1EC7n\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 104,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 78,\n    columnNumber: 5\n  }, this);\n}\n_s(PrivateChat, \"4hv1y8D+MntAUjkTPw2LM2Uy+AU=\");\n_c = PrivateChat;\nvar _c;\n$RefreshReg$(_c, \"PrivateChat\");","map":{"version":3,"names":["useState","useEffect","useContext","Box","Typography","List","ListItem","ListItemButton","ListItemText","Divider","axios","AuthContext","MessageArea","SocketContext","jsxDEV","_jsxDEV","PrivateChat","_s","token","user","users","setUsers","selectedUser","setSelectedUser","departmentId","setDepartmentId","socket","onlineUserIds","setOnlineUserIds","on","ids","off","fetchDepartment","_res$data$department","_res$data$departments","_res$data$departments2","res","get","process","env","REACT_APP_API_URL","headers","Authorization","depId","data","department","id","departments","err","console","error","fetchUsers","filtered","filter","u","userId","messages","setMessages","fetchHistory","children","variant","fileName","_jsxFileName","lineNumber","columnNumber","dense","sx","maxHeight","overflow","bgcolor","mt","map","disablePadding","onClick","primary","username","secondary","includes","my","mode","target","userList","initialMessages","color","_c","$RefreshReg$"],"sources":["D:/Chuyen nganh/Đồ án ATTT/KumoChat/frontend/src/components/chat/PrivateChat.jsx"],"sourcesContent":["import { useState, useEffect, useContext } from \"react\";\r\nimport { Box, Typography, List, ListItem, ListItemButton, ListItemText, Divider } from \"@mui/material\";\r\nimport axios from \"axios\";\r\nimport { AuthContext } from \"../../context/AuthContext\";\r\nimport MessageArea from \"./MessageArea\";\r\nimport { SocketContext } from \"../../context/SocketContext\";\r\n\r\nexport default function PrivateChat() {\r\n  const { token, user } = useContext(AuthContext);\r\n  const [users, setUsers] = useState([]);\r\n  const [selectedUser, setSelectedUser] = useState(null);\r\n  const [departmentId, setDepartmentId] = useState(null);\r\n\r\n  const { socket } = useContext(SocketContext);\r\n  const [onlineUserIds, setOnlineUserIds] = useState([]);\r\n\r\n  useEffect(() => {\r\n    if (!socket) return;\r\n    socket.on(\"update_online_users\", (ids) => setOnlineUserIds(ids));\r\n    return () => socket.off(\"update_online_users\");\r\n  }, [socket]);\r\n\r\n  // Lấy phòng ban của mình trước\r\n  useEffect(() => {\r\n    const fetchDepartment = async () => {\r\n      try {\r\n        const res = await axios.get(`${process.env.REACT_APP_API_URL}/auth/me`, {\r\n          headers: { Authorization: `Bearer ${token}` }\r\n        });\r\n        const depId = res.data.department?.id || res.data.departments?.[0]?.id;\r\n        setDepartmentId(depId);\r\n      } catch (err) {\r\n        console.error(\"❌ Lỗi lấy phòng ban:\", err);\r\n      }\r\n    };\r\n    fetchDepartment();\r\n  }, [token]);\r\n\r\n  // Sau đó fetch user cùng phòng ban\r\n  useEffect(() => {\r\n    const fetchUsers = async () => {\r\n      if (!departmentId) return;\r\n      try {\r\n        const res = await axios.get(`${process.env.REACT_APP_API_URL}/departments/${departmentId}/users`, {\r\n          headers: { Authorization: `Bearer ${token}` }\r\n        });\r\n\r\n        const filtered = res.data.filter(u => u.id !== user.userId);\r\n        setUsers(filtered);\r\n      } catch (err) {\r\n        console.error(\"❌ Lỗi lấy user trong phòng ban:\", err);\r\n      }\r\n    };\r\n    fetchUsers();\r\n  }, [departmentId, token, user.userId]);\r\n\r\n  const [messages, setMessages] = useState([]);\r\n  \r\n  // Load tin nhắn cũ\r\n  useEffect(() => {\r\n    const fetchHistory = async () => {\r\n      if (!selectedUser) return;\r\n      try {\r\n        const res = await axios.get(\r\n          `${process.env.REACT_APP_API_URL}/messages/private/${selectedUser.id}`,\r\n          { headers: { Authorization: `Bearer ${token}` } }\r\n        );\r\n        setMessages(res.data); // 👈 lưu tin nhắn cũ\r\n      } catch (err) {\r\n        console.error(\"❌ Không lấy được tin nhắn cũ:\", err);\r\n      }\r\n    };\r\n\r\n    fetchHistory();\r\n  }, [selectedUser, token]);\r\n\r\n  return (\r\n    <Box>\r\n      <Typography variant=\"subtitle1\">🧍 Chọn người trong phòng ban để nhắn tin</Typography>\r\n\r\n      <List dense sx={{ maxHeight: 200, overflow: \"auto\", bgcolor: \"#f4f4f4\", mt: 1 }}>\r\n        {users.map((u) => (\r\n          <ListItem key={u.id} disablePadding>\r\n            <ListItemButton onClick={() => setSelectedUser(u)}>\r\n              <ListItemText\r\n                primary={u.username}\r\n                secondary={onlineUserIds.includes(u.id) ? \"🟢 Online\" : \"⚪️ Offline\"}\r\n              />\r\n            </ListItemButton>\r\n          </ListItem>\r\n        ))}\r\n      </List>\r\n\r\n      <Divider sx={{ my: 2 }} />\r\n\r\n      {selectedUser ? (\r\n        <MessageArea\r\n          mode=\"private\"\r\n          target={selectedUser}\r\n          userList={users}\r\n          initialMessages={messages}\r\n        />\r\n      ) : (\r\n        <Typography variant=\"body2\" color=\"text.secondary\">\r\n          Chọn một người để bắt đầu trò chuyện\r\n        </Typography>\r\n      )}\r\n    </Box>\r\n  );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}