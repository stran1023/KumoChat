{"ast":null,"code":"var _jsxFileName = \"D:\\\\Chuyen nganh\\\\\\u0110\\u1ED3 \\xE1n ATTT\\\\KumoChat\\\\frontend\\\\src\\\\components\\\\chat\\\\PrivateChat.jsx\",\n  _s = $RefreshSig$();\nimport { useState, useEffect, useContext } from \"react\";\nimport { Box, Typography, List, ListItem, ListItemButton, ListItemText, Divider } from \"@mui/material\";\nimport axios from \"axios\";\nimport { AuthContext } from \"../../context/AuthContext\";\nimport MessageArea from \"./MessageArea\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nexport default function PrivateChat() {\n  _s();\n  const {\n    token,\n    user\n  } = useContext(AuthContext);\n  const [users, setUsers] = useState([]);\n  const [selectedUser, setSelectedUser] = useState(null);\n  const [departmentId, setDepartmentId] = useState(null);\n\n  // Lấy phòng ban của mình trước\n  useEffect(() => {\n    const fetchDepartment = async () => {\n      try {\n        var _res$data$department, _res$data$departments, _res$data$departments2;\n        const res = await axios.get(`${process.env.REACT_APP_API_URL}/auth/me`, {\n          headers: {\n            Authorization: `Bearer ${token}`\n          }\n        });\n        const depId = ((_res$data$department = res.data.department) === null || _res$data$department === void 0 ? void 0 : _res$data$department.id) || ((_res$data$departments = res.data.departments) === null || _res$data$departments === void 0 ? void 0 : (_res$data$departments2 = _res$data$departments[0]) === null || _res$data$departments2 === void 0 ? void 0 : _res$data$departments2.id);\n        setDepartmentId(depId);\n      } catch (err) {\n        console.error(\"❌ Lỗi lấy phòng ban:\", err);\n      }\n    };\n    fetchDepartment();\n  }, [token]);\n\n  // Sau đó fetch user cùng phòng ban\n  useEffect(() => {\n    const fetchUsers = async () => {\n      if (!departmentId) return;\n      try {\n        const res = await axios.get(`${process.env.REACT_APP_API_URL}/departments/${departmentId}/users`, {\n          headers: {\n            Authorization: `Bearer ${token}`\n          }\n        });\n        const filtered = res.data.filter(u => u.id !== user.userId);\n        setUsers(filtered);\n      } catch (err) {\n        console.error(\"❌ Lỗi lấy user trong phòng ban:\", err);\n      }\n    };\n    fetchUsers();\n  }, [departmentId, token, user.userId]);\n  const [messages, setMessages] = useState([]);\n  useEffect(() => {\n    const fetchHistory = async () => {\n      if (!selectedUser) return;\n      try {\n        const res = await axios.get(`${process.env.REACT_APP_API_URL}/messages/private/${selectedUser.id}`, {\n          headers: {\n            Authorization: `Bearer ${token}`\n          }\n        });\n        setMessages(res.data); // 👈 lưu tin nhắn cũ\n      } catch (err) {\n        console.error(\"❌ Không lấy được tin nhắn cũ:\", err);\n      }\n    };\n    fetchHistory();\n  }, [selectedUser, token]);\n  return /*#__PURE__*/_jsxDEV(Box, {\n    children: [/*#__PURE__*/_jsxDEV(Typography, {\n      variant: \"subtitle1\",\n      children: \"\\uD83E\\uDDCD Ch\\u1ECDn ng\\u01B0\\u1EDDi trong ph\\xF2ng ban \\u0111\\u1EC3 nh\\u1EAFn tin\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 68,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(List, {\n      dense: true,\n      sx: {\n        maxHeight: 200,\n        overflow: \"auto\",\n        bgcolor: \"#f4f4f4\",\n        mt: 1\n      },\n      children: users.map(u => /*#__PURE__*/_jsxDEV(ListItem, {\n        disablePadding: true,\n        children: /*#__PURE__*/_jsxDEV(ListItemButton, {\n          onClick: () => setSelectedUser(u),\n          children: /*#__PURE__*/_jsxDEV(ListItemText, {\n            primary: u.username,\n            secondary: onlineUserIds.includes(u.id) ? \"🟢 Online\" : \"⚪️ Offline\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 74,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 73,\n          columnNumber: 13\n        }, this)\n      }, u.id, false, {\n        fileName: _jsxFileName,\n        lineNumber: 72,\n        columnNumber: 11\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 70,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Divider, {\n      sx: {\n        my: 2\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 83,\n      columnNumber: 7\n    }, this), selectedUser ? /*#__PURE__*/_jsxDEV(MessageArea, {\n      mode: \"private\",\n      target: selectedUser,\n      userList: users,\n      initialMessages: messages\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 86,\n      columnNumber: 9\n    }, this) : /*#__PURE__*/_jsxDEV(Typography, {\n      variant: \"body2\",\n      color: \"text.secondary\",\n      children: \"Ch\\u1ECDn m\\u1ED9t ng\\u01B0\\u1EDDi \\u0111\\u1EC3 b\\u1EAFt \\u0111\\u1EA7u tr\\xF2 chuy\\u1EC7n\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 93,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 67,\n    columnNumber: 5\n  }, this);\n}\n_s(PrivateChat, \"wofW8K9EGEz2+e51WHou5t1N4rs=\");\n_c = PrivateChat;\nvar _c;\n$RefreshReg$(_c, \"PrivateChat\");","map":{"version":3,"names":["useState","useEffect","useContext","Box","Typography","List","ListItem","ListItemButton","ListItemText","Divider","axios","AuthContext","MessageArea","jsxDEV","_jsxDEV","PrivateChat","_s","token","user","users","setUsers","selectedUser","setSelectedUser","departmentId","setDepartmentId","fetchDepartment","_res$data$department","_res$data$departments","_res$data$departments2","res","get","process","env","REACT_APP_API_URL","headers","Authorization","depId","data","department","id","departments","err","console","error","fetchUsers","filtered","filter","u","userId","messages","setMessages","fetchHistory","children","variant","fileName","_jsxFileName","lineNumber","columnNumber","dense","sx","maxHeight","overflow","bgcolor","mt","map","disablePadding","onClick","primary","username","secondary","onlineUserIds","includes","my","mode","target","userList","initialMessages","color","_c","$RefreshReg$"],"sources":["D:/Chuyen nganh/Đồ án ATTT/KumoChat/frontend/src/components/chat/PrivateChat.jsx"],"sourcesContent":["import { useState, useEffect, useContext } from \"react\";\r\nimport { Box, Typography, List, ListItem, ListItemButton, ListItemText, Divider } from \"@mui/material\";\r\nimport axios from \"axios\";\r\nimport { AuthContext } from \"../../context/AuthContext\";\r\nimport MessageArea from \"./MessageArea\";\r\n\r\nexport default function PrivateChat() {\r\n  const { token, user } = useContext(AuthContext);\r\n  const [users, setUsers] = useState([]);\r\n  const [selectedUser, setSelectedUser] = useState(null);\r\n  const [departmentId, setDepartmentId] = useState(null);\r\n\r\n  // Lấy phòng ban của mình trước\r\n  useEffect(() => {\r\n    const fetchDepartment = async () => {\r\n      try {\r\n        const res = await axios.get(`${process.env.REACT_APP_API_URL}/auth/me`, {\r\n          headers: { Authorization: `Bearer ${token}` }\r\n        });\r\n        const depId = res.data.department?.id || res.data.departments?.[0]?.id;\r\n        setDepartmentId(depId);\r\n      } catch (err) {\r\n        console.error(\"❌ Lỗi lấy phòng ban:\", err);\r\n      }\r\n    };\r\n    fetchDepartment();\r\n  }, [token]);\r\n\r\n  // Sau đó fetch user cùng phòng ban\r\n  useEffect(() => {\r\n    const fetchUsers = async () => {\r\n      if (!departmentId) return;\r\n      try {\r\n        const res = await axios.get(`${process.env.REACT_APP_API_URL}/departments/${departmentId}/users`, {\r\n          headers: { Authorization: `Bearer ${token}` }\r\n        });\r\n\r\n        const filtered = res.data.filter(u => u.id !== user.userId);\r\n        setUsers(filtered);\r\n      } catch (err) {\r\n        console.error(\"❌ Lỗi lấy user trong phòng ban:\", err);\r\n      }\r\n    };\r\n    fetchUsers();\r\n  }, [departmentId, token, user.userId]);\r\n\r\n  const [messages, setMessages] = useState([]);\r\n\r\n  useEffect(() => {\r\n    const fetchHistory = async () => {\r\n      if (!selectedUser) return;\r\n      try {\r\n        const res = await axios.get(\r\n          `${process.env.REACT_APP_API_URL}/messages/private/${selectedUser.id}`,\r\n          { headers: { Authorization: `Bearer ${token}` } }\r\n        );\r\n        setMessages(res.data); // 👈 lưu tin nhắn cũ\r\n      } catch (err) {\r\n        console.error(\"❌ Không lấy được tin nhắn cũ:\", err);\r\n      }\r\n    };\r\n\r\n    fetchHistory();\r\n  }, [selectedUser, token]);\r\n\r\n  return (\r\n    <Box>\r\n      <Typography variant=\"subtitle1\">🧍 Chọn người trong phòng ban để nhắn tin</Typography>\r\n\r\n      <List dense sx={{ maxHeight: 200, overflow: \"auto\", bgcolor: \"#f4f4f4\", mt: 1 }}>\r\n        {users.map((u) => (\r\n          <ListItem key={u.id} disablePadding>\r\n            <ListItemButton onClick={() => setSelectedUser(u)}>\r\n              <ListItemText\r\n                primary={u.username}\r\n                secondary={onlineUserIds.includes(u.id) ? \"🟢 Online\" : \"⚪️ Offline\"}\r\n              />\r\n            </ListItemButton>\r\n          </ListItem>\r\n        ))}\r\n      </List>\r\n\r\n      <Divider sx={{ my: 2 }} />\r\n\r\n      {selectedUser ? (\r\n        <MessageArea\r\n          mode=\"private\"\r\n          target={selectedUser}\r\n          userList={users}\r\n          initialMessages={messages}\r\n        />\r\n      ) : (\r\n        <Typography variant=\"body2\" color=\"text.secondary\">\r\n          Chọn một người để bắt đầu trò chuyện\r\n        </Typography>\r\n      )}\r\n    </Box>\r\n  );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}